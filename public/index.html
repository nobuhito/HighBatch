<!DOCTYPE html>
<html lang="ja">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>HighBatch</title>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/zenburn.css">
    <link rel="stylesheet" href="">
    <link rel="shortcut icon" href="">
    <style>
       body { padding-top: 70px; }
       .btn {
           margin-left: 5px;
       }
       .glyphicon {
           margin-right: 2px;
       }
       .resolve {
           float: right;
       }
       .execute {
           float: right;
       }
        pre.console {
            background: #3f3f3f;
            color: #dcdcdc;
        }
        .list-group-item {
            padding: 5px 15px;
        }
    </style>
</head>
<body>
    <!-- Place your content here -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                HighBatch
            </a>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row" >
            <div class="col-sm-8" id="article-wrap">
                <article id="article"></article>
            </div>
            <div class="col-sm-4" id="nav-wrap" >
                <nav id="nav"></nav>
            </div>
        </div>
        <div id="lightbox-outer"></div>
    </div>
    <!-- SCRIPTS -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-lightbox/0.7.0/bootstrap-lightbox.js"></script>
    <script src="/js/highlight.pack.js"></script>
    <script src="/js/bootstrap-treeview.min.js"></script>
    <script>
     function getPanelHeading(d) {
         var titleStr = d["hostname"] + " / " + d["name"] + " / " + d["duration"].replace(/^(.*\d\.\d)\d+(s)$/, "$1$2");
         var exitClass = (d["exitCode"] > 0)?
                         "text-danger glyphicon-warning-sign":
                         "text-success glyphicon-ok";
         exitClass = (d["completed"] == "")?
                     "text-success glyphicon glyphicon-repeat": exitClass;
         exitClass = (d["resolved"] != "")?
                     "text-primary glyphicon glyphicon-thumbs-up": exitClass;
         var titleAlert = $("<div>").append(
             $("<span>").addClass(exitClass)
                        .addClass("glyphicon")
                        .attr({
                            "aria-hidden": "true"
                        }));
         titleStr = $(titleAlert).html() + " " + titleStr;
         var title = $("<a>").html(titleStr)
                             .addClass("collapsed")
                             .attr({
                                 "href": "#c-" + d["id"],
                                 "data-toggle": "collapse",
                                 "data-parent": "#accordion",
                                 "aria-expanded": "false",
                                 "aria-controls": "c-" + d["id"]
                             });
         var panelTitle = $("<h4>").addClass("panel-title")
                                   .append(title);
         var panelHeading = $("<div>").addClass("panel-heading")
                                      .attr({
                                          "role": "tab",
                                          "id": "p-" + d["id"]
                                      })
                                      .append(panelTitle);
         return panelHeading;
     }

     function getTabPanel(d) {
         var tabPanel = $("<div>").attr("role", "tabpanel");
         var navTabs = $("<ul>").addClass("nav nav-tabs")
                                .attr({
                                    "role": "tablist"
                                });
         var tabContent = $("<div>").addClass("tab-content");
         var idActive = d["id"] + "output";
         var aActive = $("<a>").text("output")
                         .attr({
                             href: "#" + idActive,
                             "aria-controls": idActive,
                             role: "tab",
                             "data-toggle": "tab",
                         });
         var preesntationActive = $("<li>").addClass("active")
                                           .attr({
                                               role: "presentation"
                                           })
                                           .append(aActive)
                                           .appendTo(navTabs);
         var outputStr = d["output"];
         if (d["error"] != "") {
             var re = new RegExp(d["error"], "gi");
             var replace = "<span class=\"bg-danger text-danger\">$1</span>";
             outputStr = d["output"].trim().replace(re, replace);
         }
         var output = $("<pre>").addClass("console").html(outputStr);
         var tabPaneActive = $("<div>").addClass("tab-pane active")
                                       .attr({
                                           id: idActive,
                                           role: "tabpanel"
                                       })
                                       .append(output);
         tabContent.append(tabPaneActive).appendTo(navTabs);

         for (i in d["assets"]) {
             var id = d["id"] + d["assets"][i].replace(/[^\w\d]/, "");
             var a = $("<a>").text(d["assets"][i])
                             .attr({
                                 href: "/source/" + d["name"] + "/" + d["assets"][i],
                                 "data-target": "#" + id,
                                 "aria-controls": id,
                                 role: "tab",
                                 "data-toggle": "tabajax"
                             })
                             .click(function(e) {
                                 var $this = $(this),
                                     loadurl = $this.attr("href"),
                                     target = $this.attr("data-target");

                                 $.ajax({
                                     url: loadurl,
                                     cache: true
                                 }).done(function(data) {
                                     var html = hljs.highlightAuto(data).value;
                                     $(target).html("<pre class=\"hljs\">" + html + "</pre>");
                                 });
                                 $this.tab("show");
                                 return false;
                             });
             var preesntation = $("<li>").append(a)
                                         .attr("role", "presentation")
                                         .appendTo(navTabs);
             var asset = $("<pre>");
             var tabPane = $("<div>").addClass("tab-pane")
                                     .attr({
                                         id: id,
                                         role: "tabpanel"
                                     })
                                     .append(asset);
             tabContent.append(tabPane).appendTo(navTabs);
         }

         tabPanel.append(navTabs).append(tabContent);
         return tabPanel;
     }

     function getPanelCollapse(d) {
         var info = $("<dl>").addClass("dl-horizontal");

         for (j in d) {
             var s = d[j];
             var notPrintItems = ["output", "durationInt", "durationAve", "id", "key"]
             if (notPrintItems.indexOf(j) > -1 || s == "" || s == null ) { continue };
             if (j == "chain") {
                 var arrow = (d["onErrorStop"] == "" || d["exitCode"] == 0)?
                             " -> ": " -> X ";
                 if (s != null && s != "") {
                     s = arrow + s.join(", ");
                 } else {
                     s = ""
                 }
             }
             if (["completed", "started", "resolved"].indexOf(j) > -1) {
                 s = dt2datetime(s);
             }
             if (j == "duration") {
                 s = s.replace(/^(.*\d\.\d)\d+(s)$/, "$1$2")
                     .replace(/([hms])/g, "$1 ").replace("m s", "ms")
             }
             if (j == "route") {
                 if (s != null && s != "") {
                     s = s.join(" -> ") + " ->";
                 } else {
                     s = "";
                 }
             }
             if (j == "schedule") {
                 if (s != "manual") {
                     var jwd = ["日", "月", "火", "水", "木", "金", "土"]
                     var c = s.split(" ");
                     c.reverse();
                     var wd = (/^[0-6]$/.test(c[0]))? jwd[c[0]]:c[0];
                     s = wd + "曜日 " + c[1] + "月 " + c[2] + "日 ";
                     s = s + c[3] + "時 " + c[4] + "分 " + c[5] + "秒";
                 }
             }
             s = "<span style=\"font-family:monospace\">" + s + "</span>";
             $("<dt>").text(j.toUpperCase()).appendTo(info);
             $("<dd>").html(s).appendTo(info);
         }


         var panelBody = $("<div>").addClass("panel-body")
                                   .append(info);

         if (d["completed"] != "") {

             var tabPanel = getTabPanel(d);
             panelBody.append(tabPanel);

             panelBody.append(
                 $("<a>").addClass("execute btn btn-danger")
                         .attr("href", "/exec/" + d["key"])
                         .text("ReExecute")
                         .prepend(
                             $("<span>").addClass("glyphicon glyphicon-flash")
                                        .attr("aria-hidden", "true")
                         )
             );

             if (d["exitCode"] != 0 && d["resolved"] == "") {
                 panelBody.append(
                     $("<a>").addClass("resolve btn btn-primary")
                             .attr("href", "/resolve/" + d["id"])
                             .text("Resolve")
                             .prepend(
                                 $("<span>").addClass("glyphicon glyphicon-thumbs-up")
                                            .attr("aria-hidden", "true")
                             )
                 );

             }
         } else {
             var progress = $("<div>").addClass("progress");
             var v = getProgresValue(d["durationAve"], d["started"]);
             var id = "progress-" + d["key"] + d["hostname"] + d["started"];
             var progressBar = $("<div>").addClass("progress-bar")
                                         .attr({
                                             "id": id,
                                             role: "progressbar",
                                             "aria-valuenow": v,
                                             "aria-valuemin": 0,
                                             "aria-valuemax": 100,
                                             "data-duration": d["durationAve"],
                                             "data-started": d["started"]
                                         })
                                         .css({
                                             width: v + "%"
                                         })
                                         .text(v + "%").appendTo(progress);

             panelBody.append(progress);
             setInterval(function(id) {
                 progressBarUpdate(id);
             }, 1000, id);
         }
         var panelCollapse = $("<div>").addClass("panel-collapse collapse")
                                       .attr({
                                           "role": "tabpanel",
                                           "aria-labelledby": "p-" + d["id"],
                                           "id": "c-" + d["id"]
                                       })
                                       .append(panelBody);
         return panelCollapse;
     }

     function getProgresValue(durationAve, started) {
         var m = started.match(/^(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/);
         var starttime = new Date(m[1], m[2] - 1, m[3], m[4], m[5], m[6], 0);
         var duration = new Date() - starttime;
         var v = (duration * 100 / (durationAve / 1000000)).toString()
                                                           .replace(/(.*\.\d).*/, "$1");
         return (v > 100)? 100: v;
     }

     function progressBarUpdate(target) {
         var t = $("#" + target);
         var value = getProgresValue(t.attr("data-duration"), t.attr("data-started"));
         t.attr("aria-valuenow", value)
                  .css("width", value + "%")
                  .text(value + "%");
     }

     function dt2datetime(dt) {
         var datetime = "";
         m = dt.match(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/);
         datetime = m[1] + "/" + m[2] + "/" + m[3] + " " + m[4] + ":" + m[5] + ":" + m[6];
         return datetime;
     }

     function getTree(items, cb) {
         $.ajax({
             url: "/worker/list",
             cache: false
         }).done( function(data) {
             var workers = {};
             for (var w in data) {
                 console.log(data)
                 workers[data[w]["host"]] = data[w]["isAlive"]
             }
             console.log(workers);
             var tree = [];
             for (var hostname in items) {
                 alltag = 0;
                 var h = {};
                 var icon = (workers[hostname] == 1)? "glyphicon glyphicon-tasks": "glyphicon glyphicon-question-sign text-danger";
                 h.text = hostname;
                 h.icon = icon
                 h.href = "#" + hostname;
                 h.nodes = [];
                 for (var key in items[hostname]) {
                     var k = {};
                     k.text = items[hostname][key]["name"];
                     k.icon = "glyphicon glyphicon-time";
                     k.href = "#" + hostname + "/" + key;
                     k.nodes = [];
                     var tag = 0;
                     for (var i in items[hostname][key]["error"]) {
                         error = items[hostname][key]["error"][i];
                         var item = {
                             "text": dt2datetime(error),
                             "icon": "glyphicon glyphicon-exclamation-sign",
                             "href": "#p-" + error
                         };
                         k.nodes.push(item);
                         tag++;
                     }
                     if (tag > 0) { k.tags = [tag]; }
                     h.nodes.push(k);
                     alltag = alltag + tag;
                 }
                 if (alltag > 0) { h.tags = [alltag]; }
                 tree.push(h);
             }
             cb(tree);
         });
     }

     function doTreeview(tree) {
         $("#nav").treeview({
             data: tree,
             showBorder: false,
             showTags: true,
             collapseIcon: "glyphicon glyphicon-chevron-down",
             expandIcon: "glyphicon glyphicon-chevron-right",
             enableLinks: true,
             onNodeSelected: function(event, data) {
                 if (/^#p\-/.test(data.href)) {
                     $(data.href).children().children().click();
                 } else {
                     load("/data/" + data.href.replace("#", ""), false);
                 }
             }
         });
     }

     function render(d) {
         var panelHeading = getPanelHeading(d);
         var panelCollapse = getPanelCollapse(d);
         var panel = $("<div>").addClass("panel panel-default")
                               .append(panelHeading)
                               .append(panelCollapse)
                               .appendTo($("#accordion"));
     }

     function load(path, bothTree) {
         $("#article").html("");
         var panelGroup = $("<div>").addClass("panel-group")
                                    .attr({
                                        id: "accordion",
                                        role: "tablist",
                                        "aria-multiselectable": true
                                    })
                                    .appendTo($("#article"));

         $.ajax({
             url: path,
             cache: false
         }).done( function(data) {

             var durationTable = {}
             for (i in data) {
                 var d = data[i];

                 if (!(d["hostname"] + d["key"] in durationTable)) {
                     durationTable[d["hostname"] + d["key"]] = {
                         count: 0,
                         value: 0
                     };
                 }
                 var t = durationTable[d["hostname"] + d["key"]];
                 if (d["durationInt"] != 0) {
                     var  i = {
                         count: parseInt(t.count) + 1,
                         value: parseInt(t.value) + parseInt(d["durationInt"])
                     }
                     durationTable[d["hostname"] + d["key"]] = i;
                 }
             }

             var items = {};
             for (i in data) {
                 var d = data[i];
                 var t = durationTable[d["hostname"] + d["key"]];
                 if (t.count > 0) {
                     d.durationAve = (t.value / t.count);
                 }

                 setTimeout(render, 100, d);

                 if (bothTree == true) {
                     var h = d["hostname"];
                     if (!(h in items)) { items[h] = {}; }
                     if (!(d["key"] in items[h])) { items[h][d["key"]] = {}; }
                     items[h][d["key"]]["name"] = d["name"];

                     var k = d["key"];
                     if (!("error" in items[h][k])) { items[h][k]["error"] = []; }
                     if (d["exitCode"] > 0 && d["resolved"] == "") {
                         items[h][k]["error"].push(d["id"]);
                     }
                 }
             }

             if (bothTree == true) {
                 getTree(items, function(tree) {
                     doTreeview(tree);
                 });
             }

             $(".collapse").collapse('hide');
         });
     }

     $(function($){
         load("/data", true);

         $("#nav").parent().hover(
             function() {
                 $("#nav-wrap").removeClass().addClass("col-sm-6");
                 $("#article-wrap").removeClass().addClass("col-sm-6");
             },
             function() {
                 $("#nav-wrap").removeClass().addClass("col-sm-4");
                 $("#article-wrap").removeClass().addClass("col-sm-8");
             }
         );

         $(function () {
             $('.panel-group').on('shown.bs.collapse', function (e) {
                 var offset = $('.panel.panel-default > .panel-collapse.in').offset();
                 if(offset) {
                     $('html,body').animate({
                         scrollTop: $('.panel-collapse.in').siblings('.panel-heading').offset().top - 70
                     }, 200);
                 }
             });
         });


     });
    </script>
</body>
</html>
